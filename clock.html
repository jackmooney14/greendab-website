<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Now Playing</title>
  <script src="./clock_files/socket.io.min.js.download"></script>
  <style>
    :root {
      --primary-color: #155778;
      --text-color:    #ffffff;
      --accent-color:  rgba(255, 0, 0, 0.5);
      --box-bg:        rgba(255,255,255,0.1);
      --fade-duration: 0.5s;
      --clock-max:     420px;
      --clock-gap:     1.5rem;
    }

    * { box-sizing: border-box; }

    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      background: var(--primary-color);
      font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
      color: var(--text-color);
      overflow: hidden;
    }

    header {
      display: flex; align-items: center;
      padding: 1rem 2rem;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }
    header img.logo { height: 60px; margin-right: 1rem; }
    header .station-info { font-size: 1.5rem; font-weight: 700; }

    .container {
      display: flex;
      height: calc(100% - 82px);
    }

    .left {
      flex: 0 0 33%;
      display: flex; align-items: center; justify-content: center;
      padding: 1rem;
    }
    #cover {
      max-width: 100%; max-height: 100%;
      object-fit: cover; border-radius: 1rem;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
      opacity: 1; transition: opacity var(--fade-duration) ease-in-out;
    }

    .right {
      flex: 1;
      position: relative;
    }

    .info-section {
      position: absolute;
      bottom: var(--clock-gap);
      left: 1rem;
      right: calc(var(--clock-max) + var(--clock-gap));
      padding: 0 1rem;
    }
    .info-box {
      position: relative;
      background: var(--box-bg);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 1rem;
      padding: 1.5rem 2rem 1rem;
      width: 100%;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      text-align: center;
    }
    .info-box::before {
      content: "Now Playing";
      position: absolute;
      top: -1.2rem; left: 1.5rem;
      background: var(--primary-color);
      padding: 0.2rem 0.8rem;
      font-size: 0.9rem; font-weight: 700;
      border-top-left-radius: 0.5rem;
      border-top-right-radius: 0.5rem;
    }
    .info-box h1, .info-box h2 {
      margin: 0;
      opacity: 1; transition: opacity var(--fade-duration) ease-in-out;
    }
    .info-box h1 {
      font-size: clamp(2rem, 6vw, 3rem);
      margin-bottom: 0.5rem;
      text-shadow: 0 0 6px rgba(0,0,0,0.5);
    }
    .info-box h2 {
      font-size: clamp(1.5rem, 5vw, 2rem);
      font-weight: 500;
      text-shadow: 0 0 4px rgba(0,0,0,0.5);
    }

    #clock-container {
      position: absolute;
      top: var(--clock-gap);
      right: var(--clock-gap);
      text-align: center;
      width: var(--clock-max);
    }
    #digital-clock {
      font-family: monospace;
      font-size: 3em;
      font-weight: 700;
      margin-bottom: 0.5rem;
      text-shadow: 0 0 6px rgba(0,0,0,0.5);
      transition: opacity var(--fade-duration) ease-in-out;
    }
    #analog-clock {
      width: 100%;
      aspect-ratio: 1/1;
      background: var(--text-color);
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(0,0,0,0.4);
      display: block;
    }
    #time-text {
      margin-top: 0.5rem;
      font-size: 3em;
      font-weight: 600;
      text-shadow: 0 0 6px rgba(0,0,0,0.5);
      transition: opacity var(--fade-duration) ease-in-out;
    }

    /* Audio meters */
    #audio-meters {
      position: absolute;
      top: calc(var(--clock-gap) + 10rem);
      right: var(--clock-gap);
      display: flex;
      flex-direction: row;
      gap: 1rem;
      align-items: flex-end;
      z-index: 10;
    }
    .audio-meter {
      width: 20px;
      height: 120px;
      background: #333;
      border-radius: 4px;
      overflow: hidden;
      box-shadow: 0 0 6px rgba(0,0,0,0.5);
    }
    .audio-meter-fill {
      width: 100%;
      height: 0%;
      background: linear-gradient(to top, red, yellow, lime);
      transition: height 0.1s ease-out;
    }
    #loud-warning {
      position: absolute;
      top: calc(var(--clock-gap) + 19rem);
      right: var(--clock-gap);
      color: red;
      font-weight: bold;
      font-size: 1.2rem;
      visibility: hidden;
      z-index: 10;
    }
  </style>
</head>
<body>
  <header>
    <img class="logo" src="./clock_files/maritime.png" alt="Maritime Radio logo">
    <div class="station-info">Maritime Radio ‚Äì 96.5 FM</div>
  </header>

  <div class="container">
    <div class="left">
      <img id="cover" src="./clock_files/maritime.png" alt="Album Art">
    </div>
    <div class="right">
      <div class="info-section">
        <div class="info-box">
          <h1 id="artist">Mike Chaman</h1>
          <h2 id="title">Worldless Mantra</h2>
        </div>
      </div>
      <div id="clock-container">
        <div id="digital-clock">08:40:29</div>
        <canvas id="analog-clock" width="420" height="420"></canvas>
        <div id="time-text">Twenty Minutes To Nine</div>
      </div>

      <!-- üéöÔ∏è Stereo Audio Meters -->
      <div id="audio-meters">
        <div class="audio-meter"><div id="left-fill" class="audio-meter-fill"></div></div>
        <div class="audio-meter"><div id="right-fill" class="audio-meter-fill"></div></div>
      </div>
      <div id="loud-warning">‚ö†Ô∏è Loud Input Level!</div>
    </div>
  </div>

  <script>
    const socket   = io(),
          coverImg = document.getElementById('cover'),
          artistEl = document.getElementById('artist'),
          titleEl  = document.getElementById('title');

    function fadeUpdate(el, text, isImg=false) {
      el.style.opacity = 0;
      setTimeout(() => {
        if (isImg) el.src = text || '';
        else       el.textContent = text;
        el.style.opacity = 1;
      }, 500);
    }

    socket.on('update', data => {
      fadeUpdate(coverImg, data.album_art, true);
      fadeUpdate(artistEl, data.artist);
      fadeUpdate(titleEl,  data.title);
    });

    const canvas = document.getElementById('analog-clock'),
          ctx    = canvas.getContext('2d');
    let radius;

    function resizeCanvas() {
      const size = canvas.clientWidth;
      canvas.width  = size;
      canvas.height = size;
      ctx.resetTransform();
      ctx.translate(size/2, size/2);
      radius = size/2 * 0.90;
    }

    function drawClock() {
      resizeCanvas();
      updateDigital();
      drawFace();
      drawTicks();
      drawNumbers();
      drawHands();
      updateSpelled();
    }

    function updateDigital() {
      const n = new Date(),
            hh = String(n.getHours()).padStart(2,'0'),
            mm = String(n.getMinutes()).padStart(2,'0'),
            ss = String(n.getSeconds()).padStart(2,'0');
      document.getElementById('digital-clock').textContent = `${hh}:${mm}:${ss}`;
    }

    function drawFace() {
      ctx.beginPath();
      ctx.arc(0, 0, radius, 0, 2*Math.PI);
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.beginPath();
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
      ctx.lineWidth = radius * 0.08;
      const start = (45/60)*2*Math.PI - Math.PI/2,
            end   = (60/60)*2*Math.PI - Math.PI/2;
      ctx.arc(0, 0, radius*0.88, start, end);
      ctx.stroke();
    }

    function drawTicks() {
      const pc = getComputedStyle(document.documentElement).getPropertyValue('--primary-color').trim(),
            ac = getComputedStyle(document.documentElement).getPropertyValue('--accent-color').trim();
      for (let s=0; s<60; s+=2) {
        const ang = s * Math.PI/30 - Math.PI/2,
              x   = Math.cos(ang) * radius * 0.95,
              y   = Math.sin(ang) * radius * 0.95;
        ctx.beginPath();
        ctx.fillStyle = ((s/2)%2===0)? pc : ac;
        ctx.arc(x, y, radius*0.025, 0, 2*Math.PI);
        ctx.fill();
      }
    }

    function drawNumbers() {
      ctx.fillStyle = 'black';
      ctx.font = `${radius*0.15}px Arial`;
      ctx.textBaseline = 'middle';
      ctx.textAlign    = 'center';
      for (let n=1; n<=12; n++) {
        const ang = n*Math.PI/6;
        ctx.rotate(ang);
        ctx.translate(0, -radius*0.80);
        ctx.rotate(-ang);
        ctx.fillText(n, 0, 0);
        ctx.rotate(ang);
        ctx.translate(0, radius*0.80);
        ctx.rotate(-ang);
      }
    }

    function drawHands() {
      const now = new Date(),
            h   = now.getHours()%12,
            m   = now.getMinutes(),
            s   = now.getSeconds();
      drawHand((h + m/60)*Math.PI/6, radius*0.5, radius*0.07);
      drawHand(m * Math.PI/30,      radius*0.8, radius*0.05);
      drawHand(s * Math.PI/30,      radius*0.9, radius*0.02, 'red');
    }

    function drawHand(pos, len, wid, col='black') {
      ctx.beginPath();
      ctx.lineWidth = wid;
      ctx.lineCap   = 'round';
      ctx.strokeStyle = col;
      ctx.moveTo(0,0);
      ctx.rotate(pos - Math.PI/2);
      ctx.lineTo(len,0);
      ctx.stroke();
      ctx.rotate(- (pos - Math.PI/2));
    }

    function updateSpelled() {
      const n = new Date(),
            h = n.getHours()%12 || 12,
            m = n.getMinutes();
      let ph;
      if      (m===0)  ph = `${toWords(h)} o'clock`;
      else if (m===15) ph = `quarter past ${toWords(h)}`;
      else if (m===30) ph = `half past ${toWords(h)}`;
      else if (m===45) ph = `quarter to ${toWords(h===12?1:h+1)}`;
      else if (m<30)   ph = `${toWords(m)} minutes past ${toWords(h)}`;
      else { const mm=60-m; ph = `${toWords(mm)} minutes to ${toWords(h===12?1:h+1)}`; }
      document.getElementById('time-text').textContent =
        ph.replace(/\b\w+/g, w => w[0].toUpperCase()+w.slice(1));
    }

    function toWords(n) {
      const o = ["zero","one","two","three","four","five","six","seven","eight","nine",
                 "ten","eleven","twelve","thirteen","fourteen","fifteen","sixteen",
                 "seventeen","eighteen","nineteen"],
            t = ["","","twenty","thirty","forty","fifty"];
      return n<20 ? o[n] : (n%10 ? `${t[Math.floor(n/10)]}-${o[n%10]}` : t[n/10]);
    }

    drawClock();
    setInterval(drawClock, 1000);
    window.addEventListener('resize', drawClock);

    // üîä Audio Meters Script
    async function initAudioMeters() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioCtx.createMediaStreamSource(stream);
        const splitter = audioCtx.createChannelSplitter(2);

        const analyserL = audioCtx.createAnalyser();
        const analyserR = audioCtx.createAnalyser();
        analyserL.fftSize = analyserR.fftSize = 256;

        source.connect(splitter);
        splitter.connect(analyserL, 0);
        splitter.connect(analyserR, 1);

        const bufferL = new Uint8Array(analyserL.frequencyBinCount);
        const bufferR = new Uint8Array(analyserR.frequencyBinCount);

        const fillL = document.getElementById('left-fill');
        const fillR = document.getElementById('right-fill');
        const warning = document.getElementById('loud-warning');

        function updateMeters() {
          analyserL.getByteTimeDomainData(bufferL);
          analyserR.getByteTimeDomainData(bufferR);

          const rmsL = Math.sqrt(bufferL.reduce((a, v) => a + Math.pow(v - 128, 2), 0) / bufferL.length) / 128;
          const rmsR = Math.sqrt(bufferR.reduce((a, v) => a + Math.pow(v - 128, 2), 0) / bufferR.length) / 128;

          fillL.style.height = Math.min(100, rmsL * 100) + '%';
          fillR.style.height = Math.min(100, rmsR * 100) + '%';

          warning.style.visibility = (rmsL > 0.8 || rmsR > 0.8) ? 'visible' : 'hidden';
          requestAnimationFrame(updateMeters);
        }

        updateMeters();
      } catch (e) {
        console.error("Microphone access denied or error:", e);
      }
    }

    initAudioMeters();
  </script>
</body>
</html>
