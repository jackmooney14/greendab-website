<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SE London Presenter Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }
    h1, h2 { text-align: center; }
    .section { margin-bottom: 2em; }
    .item { background: white; padding: 1em; margin-bottom: .8em; border-left: 6px solid; border-radius: 5px; }
    .high { border-color: #e53935; }
    .medium { border-color: #fb8c00; }
    .low { border-color: #43a047; }
  </style>
</head>
<body>
  <h1>SE London Presenter Dashboard</h1>

  <div class="section" id="traffic">
    <h2>ðŸš¦ Traffic Hotspots (All Incidents)</h2>
    <div id="incidents">Loading trafficâ€¦</div>
  </div>

  <div class="section" id="roadworks-today">
    <h2>ðŸ›  Today's Roadworks</h2>
    <div id="roadworks">Loading roadworksâ€¦</div>
  </div>

  <div class="section" id="transport">
    <h2>ðŸš‡ Public Transport Status</h2>
    <div id="tube">Loading Tube statusâ€¦</div>
    <div id="river">Loading River Busâ€¦</div>
    <div id="ferry">Loading Woolwich Ferryâ€¦</div>
  </div>

  <script>
    const TOMTOM_KEY = "ZKntlBjAvEOBSRtfMsEdbo31b6UcmJHJ";
    const TFL_KEY = "044bd54cfdc94f03ba10314d52eb59fe";

    const bbox = { tl: "51.520,0.00", br: "51.30,0.42" };

    async function fetchTraffic() {
      const url = `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox.tl},${bbox.br}&fields=roadNumbers,events&language=en-GB&key=${TOMTOM_KEY}`;
      const resp = await fetch(url).then(r => r.json());
      return resp.incidents || [];
    }

    // Helper: check if an event occurs today
    function isEventToday(event) {
      if (!event || !event.startTime || !event.endTime) return false;
      const now = new Date();
      const start = new Date(event.startTime);
      const end = new Date(event.endTime);
      return start <= now && now <= end && 
        start.toDateString() === now.toDateString();
    }

    // Render all incidents
    function renderTraffic(list) {
      const container = document.getElementById("incidents");
      container.innerHTML = "";
      if (!list.length) return container.innerHTML = "<p>No traffic incidents reported.</p>";

      list.sort((a, b) => b.severity - a.severity);

      list.forEach(i => {
        const sev = i.severity >= 4 ? "high" : i.severity >= 2 ? "medium" : "low";
        const emoji = sev === "high" ? "ðŸ”´" : sev === "medium" ? "ðŸŸ " : "ðŸŸ¢";

        const type = i.type?.replaceAll("_", " ").toLowerCase() || "incident";
        const roads = i.roadNumbers?.join(", ") || "Unnamed road";
        const desc = i.events?.[0]?.description || "No description available";

        const d = document.createElement("div");
        d.className = `item ${sev}`;
        d.innerHTML = `
          <strong>${emoji} ${roads}</strong> â€“ 
          <em>${type}</em><br>
          ${desc} 
          <br><small>Severity: ${i.severity}</small>
        `;
        container.appendChild(d);
      });
    }

    // Render today's roadworks only
    function renderRoadworksToday(list) {
      const container = document.getElementById("roadworks");
      container.innerHTML = "";
      if (!list.length) return container.innerHTML = "<p>No roadworks reported for today.</p>";

      // Filter by roadworks types & occurring today
      const roadworksTypes = ["ROAD_WORK", "CONSTRUCTION", "MAINTENANCE"];
      const todayRoadworks = list.filter(i => 
        roadworksTypes.includes(i.type) &&
        i.events?.some(isEventToday)
      );

      if (!todayRoadworks.length) {
        container.innerHTML = "<p>No roadworks reported for today.</p>";
        return;
      }

      todayRoadworks.sort((a, b) => b.severity - a.severity);

      todayRoadworks.forEach(i => {
        const sev = i.severity >= 4 ? "high" : i.severity >= 2 ? "medium" : "low";
        const emoji = sev === "high" ? "ðŸ”´" : sev === "medium" ? "ðŸŸ " : "ðŸŸ¢";

        const roads = i.roadNumbers?.join(", ") || "Unnamed road";
        const desc = i.events?.[0]?.description || "No description available";

        const d = document.createElement("div");
        d.className = `item ${sev}`;
        d.innerHTML = `
          <strong>${emoji} ${roads}</strong> â€“ 
          <em>roadwork</em><br>
          ${desc} 
          <br><small>Severity: ${i.severity}</small>
        `;
        container.appendChild(d);
      });
    }

    async function updateTraffic() {
      const incidents = await fetchTraffic();
      renderTraffic(incidents);
      renderRoadworksToday(incidents);
      setTimeout(updateTraffic, 5 * 60 * 1000);
    }
    updateTraffic();

    // TfL transport status code (same as before)
    const tflBase = "https://api.tfl.gov.uk/Line";
    const keyParam = `app_key=${TFL_KEY}`;

    async function fetchTfLStatus(lines) {
      const url = `${tflBase}/${lines}/Status?${keyParam}`;
      const res = await fetch(url);
      return await res.json();
    }

    function renderStatus(containerId, data, label) {
      const container = document.getElementById(containerId);
      if (!Array.isArray(data)) {
        container.textContent = `${label}: Error retrieving data`;
        return;
      }

      const messages = data.map(line => {
        const name = line.name;
        const status = line.lineStatuses?.[0]?.statusSeverityDescription || "Unknown";
        const reason = line.lineStatuses?.[0]?.reason || "";
        return `ðŸš‰ ${name}: ${status}${reason ? ` â€“ ${reason}` : ""}`;
      });

      container.innerHTML = `<ul>${messages.map(msg => `<li>${msg}</li>`).join("")}</ul>`;
    }

    async function updateTfL() {
      try {
        const [tube, river, ferry] = await Promise.all([
          fetchTfLStatus("tube"),
          fetchTfLStatus("rb1,rb6"),
          fetchTfLStatus("woolwich-ferry")
        ]);

        renderStatus("tube", tube, "Tube");
        renderStatus("river", river, "River Bus");
        renderStatus("ferry", ferry, "Woolwich Ferry");
      } catch (err) {
        console.error("TfL Error:", err);
      }

      setTimeout(updateTfL, 5 * 60 * 1000);
    }
    updateTfL();
  </script>
</body>
</html>
