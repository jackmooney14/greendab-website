<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>SE London Presenter Dashboard</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 2em;
      max-width: 900px;
      margin: auto;
      background: #fafafa;
    }
    h1, h2 { text-align: center; }
    .section { margin-bottom: 2em; }
    .item { background: white; padding: 1em; margin-bottom: .8em; border-left: 6px solid; border-radius: 5px; }
    .high { border-color: #e53935; }
    .medium { border-color: #fb8c00; }
    .low { border-color: #43a047; }
    pre {
      white-space: pre-wrap;
      font-family: monospace;
      background: #eee;
      padding: 1em;
      border-radius: 5px;
    }
  </style>
</head>
<body>
  <h1>SE London Presenter Dashboard</h1>

  <div class="section" id="traffic">
    <h2>ðŸš¦ Traffic Hotspots (All Incidents)</h2>
    <div id="incidents">Loading trafficâ€¦</div>
  </div>

  <div class="section" id="roadworks-today">
    <h2>ðŸ›  Today's Roadworks</h2>
    <div id="roadworks">Loading roadworksâ€¦</div>
  </div>

  <div class="section" id="transport">
    <h2>ðŸš‡ Public Transport Status</h2>
    <div>
      <h3>Tube Status</h3>
      <div id="tube-status">Loading Tube statusâ€¦</div>
    </div>
    <div>
      <h3>River Bus</h3>
      <div id="river">Loading River Busâ€¦</div>
    </div>
    <div>
      <h3>Woolwich Ferry</h3>
      <div id="ferry">Loading Woolwich Ferryâ€¦</div>
    </div>
  </div>

  <script>
    const TOMTOM_KEY = "ZKntlBjAvEOBSRtfMsEdbo31b6UcmJHJ";
    const TFL_KEY = "044bd54cfdc94f03ba10314d52eb59fe";

    // Refresh interval for all data fetches (5 minutes)
    const REFRESH_INTERVAL_MS = 5 * 60 * 1000;

    // --- UPDATED: Coordinates for Southeast London ---
    // tlLat, tlLon, brLat, brLon
    // Roughly covering Southwark, Lambeth (East), Lewisham, Greenwich, Bexley, Bromley
    const bbox = "51.51,-0.12,51.30,0.25";
    // -------------------------------------------------

    async function fetchTraffic() {
      const url = `https://api.tomtom.com/traffic/services/5/incidentDetails?bbox=${bbox}&fields=roadNumbers,events&language=en-GB&key=${TOMTOM_KEY}`;
      try {
        const resp = await fetch(url);
        if (!resp.ok) {
          throw new Error(`TomTom API responded with status: ${resp.status} ${resp.statusText}`);
        }
        const data = await resp.json();
        return data.incidents || [];
      } catch (error) {
        console.error("Error fetching TomTom traffic data:", error);
        document.getElementById("incidents").textContent = "Error loading traffic incidents.";
        document.getElementById("roadworks").textContent = "Error loading roadworks.";
        return [];
      }
    }

    function isEventToday(event) {
      if (!event || !event.startTime || !event.endTime) return false;
      const now = new Date();
      const start = new Date(event.startTime);
      const end = new Date(event.endTime);
      return start <= now && now <= end && start.toDateString() === now.toDateString();
    }

    function renderTraffic(list) {
      const container = document.getElementById("incidents");
      container.innerHTML = "";
      if (!list.length) return container.innerHTML = "<p>No traffic incidents reported.</p>";

      list.sort((a, b) => b.severity - a.severity);

      list.forEach(i => {
        const sev = i.severity >= 4 ? "high" : i.severity >= 2 ? "medium" : "low";
        const emoji = sev === "high" ? "ðŸ”´" : sev === "medium" ? "ðŸŸ " : "ðŸŸ¢";

        const type = i.type?.replaceAll("_", " ").toLowerCase() || "incident";
        const roads = i.roadNumbers?.join(", ") || "Unnamed road";
        const desc = i.events?.[0]?.description || "No description available";

        const d = document.createElement("div");
        d.className = `item ${sev}`;
        d.innerHTML = `
          <strong>${emoji} ${roads}</strong> â€“ 
          <em>${type}</em><br>
          ${desc} 
          <br><small>Severity: ${i.severity}</small>
        `;
        container.appendChild(d);
      });
    }

    function renderRoadworksToday(list) {
      const container = document.getElementById("roadworks");
      container.innerHTML = "";
      if (!list.length) {
        container.innerHTML = "<p>No roadworks reported for today.</p>";
        return;
      }

      const roadworksTypes = ["ROAD_WORK", "CONSTRUCTION", "MAINTENANCE"];
      const todayRoadworks = list.filter(i =>
        roadworksTypes.includes(i.type) &&
        i.events?.some(isEventToday)
      );

      if (!todayRoadworks.length) {
        container.innerHTML = "<p>No roadworks reported for today.</p>";
        return;
      }

      todayRoadworks.sort((a, b) => b.severity - a.severity);

      todayRoadworks.forEach(i => {
        const sev = i.severity >= 4 ? "high" : i.severity >= 2 ? "medium" : "low";
        const emoji = sev === "high" ? "ðŸ”´" : sev === "medium" ? "ðŸŸ " : "ðŸŸ¢";

        const roads = i.roadNumbers?.join(", ") || "Unnamed road";
        const desc = i.events?.[0]?.description || "No description available";

        const d = document.createElement("div");
        d.className = `item ${sev}`;
        d.innerHTML = `
          <strong>${emoji} ${roads}</strong> â€“ 
          <em>roadwork</em><br>
          ${desc} 
          <br><small>Severity: ${i.severity}</small>
        `;
        container.appendChild(d);
      });
    }

    async function updateTraffic() {
      const incidents = await fetchTraffic();
      renderTraffic(incidents);
      renderRoadworksToday(incidents);
      setTimeout(updateTraffic, REFRESH_INTERVAL_MS);
    }
    updateTraffic();

    async function fetchTfLStatus(lines) {
      const url = `https://api.tfl.gov.uk/Line/${lines}/Status?app_key=${TFL_KEY}`;
      const res = await fetch(url);
      if (!res.ok) throw new Error(`TfL API error: ${res.status} ${res.statusText}`);
      return await res.json();
    }

    async function fetchAndRenderTubeStatus() {
      const container = document.getElementById("tube-status");
      try {
        const url = `https://api.tfl.gov.uk/Line/Mode/tube/Status?app_key=${TFL_KEY}`;
        const res = await fetch(url);
        if (!res.ok) {
          throw new Error(`TfL API error: ${res.status} ${res.statusText}`);
        }
        const data = await res.json();

        if (!Array.isArray(data) || data.length === 0) {
          container.textContent = "No Tube status data available.";
          return;
        }

        const lines = data.map(line => {
          const name = line.name || "Unknown line";
          const statusObj = line.lineStatuses?.[0];
          const status = statusObj?.statusSeverityDescription || "Status unknown";
          const reason = statusObj?.reason || "";
          return `${name}: ${status}${reason ? " â€“ " + reason : ""}`;
        });

        container.innerHTML = "<pre>" + lines.join("\n") + "</pre>";
      } catch (err) {
        container.textContent = "Error fetching Tube status: " + err.message;
        console.error(err);
      }
    }

    async function fetchAndRenderOtherStatus(containerId, lines, label) {
      const container = document.getElementById(containerId);
      try {
        const data = await fetchTfLStatus(lines);
        if (!Array.isArray(data) || data.length === 0) {
          container.textContent = `No ${label} status data available.`;
          return;
        }

        const messages = data.map(line => {
          const name = line.name || label;
          const status = line.lineStatuses?.[0]?.statusSeverityDescription || "Unknown";
          const reason = line.lineStatuses?.[0]?.reason || "";
          return `ðŸš‰ ${name}: ${status}${reason ? " â€“ " + reason : ""}`;
        });

        container.innerHTML = "<ul>" + messages.map(m => `<li>${m}</li>`).join("") + "</ul>";
      } catch (err) {
        container.textContent = `Error fetching ${label} status: ` + err.message;
        console.error(err);
      }
    }

    async function updateTfL() {
      await fetchAndRenderTubeStatus();
      await fetchAndRenderOtherStatus("river", "rb1,rb6", "River Bus");
      await fetchAndRenderOtherStatus("ferry", "woolwich-ferry", "Woolwich Ferry");
      setTimeout(updateTfL, REFRESH_INTERVAL_MS);
    }
    updateTfL();
  </script>
